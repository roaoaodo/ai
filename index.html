<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA AI</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --border: #1e1e2e;
  --accent: #7c3aed;
  --accent2: #06b6d4;
  --text: #e2e8f0;
  --muted: #64748b;
  --danger: #ef4444;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

body::before {
  content:'';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% -20%, rgba(124,58,237,0.13) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%, rgba(6,182,212,0.09) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
header {
  position: relative; z-index: 10;
  display: flex; align-items: center; gap: 10px;
  padding: 13px 20px;
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,15,0.88);
  backdrop-filter: blur(20px);
  flex-shrink: 0;
}

#menuBtn {
  width: 34px; height: 34px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 5px;
  cursor: pointer; background: none; border: none;
  border-radius: 9px; transition: background 0.2s; flex-shrink: 0;
}
#menuBtn:hover { background: rgba(255,255,255,0.07); }
#menuBtn span {
  display: block; width: 18px; height: 2px;
  background: var(--muted); border-radius: 2px;
}

.logo { width: 30px; height: 30px; flex-shrink: 0; }
.logo svg { width: 100%; height: 100%; }
.logo-ring { animation: spin 8s linear infinite; transform-origin: center; }
@keyframes spin { to { transform: rotate(360deg); } }

.h-info { flex: 1; min-width: 0; }
.h-title {
  font-family: 'Syne', sans-serif;
  font-weight: 800; font-size: 1rem; letter-spacing: 0.06em;
  background: linear-gradient(135deg, #a78bfa, #06b6d4);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.h-sub { font-size: 0.58rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; }

.h-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

.model-badge {
  padding: 4px 10px; border-radius: 100px;
  border: 1px solid var(--border); font-size: 0.6rem; color: var(--muted);
  cursor: pointer; transition: all 0.2s; background: var(--surface); white-space: nowrap;
}
.model-badge:hover { border-color: var(--accent); color: #a78bfa; }

.sdot {
  width: 7px; height: 7px; border-radius: 50%;
  background: #22c55e; box-shadow: 0 0 8px #22c55e;
  animation: pulse 2s ease-in-out infinite; flex-shrink: 0;
}
.sdot.loading { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
.sdot.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); animation: none; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }

/* Model dropdown - scrollable */
.msel {
  position: fixed; top: 60px; right: 20px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden; z-index: 300;
  display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.7); min-width: 270px;
  max-height: 420px;
  display: none;
  flex-direction: column;
}
.msel.open { display: flex; animation: fadeDown 0.15s ease; }
.msel-scroll {
  overflow-y: auto;
  flex: 1;
}
.msel-scroll::-webkit-scrollbar { width: 3px; }
.msel-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
@keyframes fadeDown { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

.mo {
  padding: 10px 15px; font-size: 0.74rem; cursor: pointer;
  transition: background 0.15s; border-bottom: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 2px;
}
.mo:last-child { border-bottom: none; }
.mo:hover { background: rgba(124,58,237,0.1); }
.mo.active { background: rgba(124,58,237,0.16); }
.mo .mn { color: #a78bfa; font-weight: 500; }
.mo .md2 { color: var(--muted); font-size: 0.6rem; }
.msel-group {
  padding: 8px 15px 4px;
  font-size: 0.58rem; font-weight: 700;
  letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--muted); background: rgba(255,255,255,0.02);
  border-bottom: 1px solid var(--border);
}

/* Copy code button */
.pre-wrap { position: relative; margin: 10px 0; }
.pre-wrap pre { margin: 0; }
.copy-btn {
  position: absolute; top: 8px; right: 8px;
  padding: 3px 10px; border-radius: 6px;
  background: rgba(124,58,237,0.2); border: 1px solid rgba(124,58,237,0.35);
  color: #a78bfa; font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem; cursor: pointer; transition: all 0.2s;
  line-height: 1.6;
}
.copy-btn:hover { background: rgba(124,58,237,0.38); }
.copy-btn.copied { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color: #4ade80; }

/* ‚ïê‚ïê CHAT OVERLAY ‚ïê‚ïê */
#chatOverlay {
  position: fixed; inset: 0; z-index: 500;
  display: none; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.72);
  backdrop-filter: blur(6px);
}
#chatOverlay.open { display: flex; animation: ovIn 0.2s ease; }
@keyframes ovIn { from{opacity:0} to{opacity:1} }

.chat-panel {
  width: 520px; max-width: 95vw;
  max-height: 82vh;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  display: flex; flex-direction: column;
  box-shadow: 0 40px 80px rgba(0,0,0,0.7);
  animation: panelIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
  overflow: hidden;
}
@keyframes panelIn { from{opacity:0;transform:scale(0.93) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }

.cp-head {
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}
.cp-title {
  font-family: 'Syne', sans-serif;
  font-size: 1rem; font-weight: 700;
  background: linear-gradient(135deg, #a78bfa, #06b6d4);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  flex: 1;
}
.cp-close {
  width: 30px; height: 30px; border-radius: 8px;
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; flex-shrink: 0;
}
.cp-close:hover { background: rgba(239,68,68,0.1); color: #f87171; border-color: rgba(239,68,68,0.3); }

.cp-new {
  padding: 10px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.new-chat-btn {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 9px 14px; border-radius: 10px;
  border: 1px dashed rgba(124,58,237,0.5);
  background: rgba(124,58,237,0.06);
  color: #a78bfa; font-family: 'JetBrains Mono', monospace;
  font-size: 0.76rem; cursor: pointer; transition: all 0.2s;
}
.new-chat-btn:hover { background: rgba(124,58,237,0.14); border-color: rgba(124,58,237,0.8); }

.cp-list {
  flex: 1; overflow-y: auto;
  padding: 8px;
  display: flex; flex-direction: column; gap: 2px;
}
.cp-list::-webkit-scrollbar { width: 3px; }
.cp-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.ci {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 12px; border-radius: 12px;
  cursor: pointer; transition: background 0.15s;
  border: 1px solid transparent;
}
.ci:hover { background: rgba(255,255,255,0.04); }
.ci.active { background: rgba(124,58,237,0.12); border-color: rgba(124,58,237,0.3); }

.ci-icon { font-size: 1rem; flex-shrink: 0; }
.ci-body { flex: 1; min-width: 0; }
.ci-name {
  font-size: 0.8rem; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ci.active .ci-name { color: #c4b5fd; }
.ci-meta { font-size: 0.62rem; color: var(--muted); margin-top: 2px; }

.ci-inp {
  width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--accent);
  border-radius: 7px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem; padding: 4px 8px; outline: none;
}

.ci-actions { display: flex; gap: 4px; flex-shrink: 0; }
.ci-btn {
  width: 28px; height: 28px; border-radius: 7px;
  background: none; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; transition: all 0.15s; color: var(--muted);
  opacity: 0;
}
.ci:hover .ci-btn { opacity: 1; }
.ci-btn.edit:hover { background: rgba(124,58,237,0.15); color: #a78bfa; }
.ci-btn.del:hover { background: rgba(239,68,68,0.12); color: #f87171; }
.ci-btn.save { opacity: 1; background: rgba(34,197,94,0.12); color: #4ade80; }
.ci-btn.save:hover { background: rgba(34,197,94,0.22); }
.ci-btn.cancel { opacity: 1; }
.ci-btn.cancel:hover { background: rgba(239,68,68,0.12); color: #f87171; }

.cp-empty {
  padding: 40px 20px; text-align: center;
  color: var(--muted); font-size: 0.78rem; line-height: 1.7;
}
.cp-empty span { font-size: 2rem; display: block; margin-bottom: 10px; opacity: 0.4; }

/* ‚ïê‚ïê CHAT AREA ‚ïê‚ïê */
#chat {
  flex: 1; overflow-y: auto;
  padding: 24px 28px;
  display: flex; flex-direction: column; gap: 18px;
  scroll-behavior: smooth;
  position: relative; z-index: 1;
}
#chat::-webkit-scrollbar { width: 4px; }
#chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.msg {
  display: flex; gap: 11px;
  animation: slideIn 0.28s cubic-bezier(0.34,1.56,0.64,1) both;
  max-width: 840px;
}
@keyframes slideIn {
  from{opacity:0;transform:translateY(14px) scale(0.97)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.msg.user { flex-direction: row-reverse; align-self: flex-end; }
.msg.ai { align-self: flex-start; }

.av {
  width: 30px; height: 30px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.62rem; font-weight: 700; flex-shrink: 0;
  font-family: 'Syne', sans-serif;
}
.msg.user .av { background: linear-gradient(135deg,#7c3aed,#a855f7); color:#fff; }
.msg.ai .av { background: linear-gradient(135deg,#0e7490,#06b6d4); color:#fff; }

.bubble {
  padding: 12px 16px; border-radius: 16px;
  font-size: 0.875rem; line-height: 1.78;
  max-width: 680px; word-break: break-word;
}
.msg.user .bubble {
  background: #1e1e3a; border: 1px solid rgba(124,58,237,0.3);
  border-top-right-radius: 4px; color: #c4b5fd;
}
.msg.ai .bubble {
  background: var(--surface); border: 1px solid var(--border);
  border-top-left-radius: 4px; color: var(--text);
}

.bubble strong { color: #a78bfa; font-weight: 600; }
.bubble em { color: #06b6d4; font-style: italic; }
.bubble code {
  background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.2);
  padding: 1px 6px; border-radius: 4px; font-size: 0.82em; color: #a78bfa;
  font-family: 'JetBrains Mono', monospace;
}
.bubble pre {
  background: #0d0d16; border: 1px solid var(--border); border-radius: 10px;
  padding: 13px; margin: 10px 0; overflow-x: auto; font-size: 0.82em; line-height: 1.6;
}
.bubble pre code { background:none; border:none; padding:0; color:#7dd3fc; }
.bubble ul,.bubble ol { padding-left:20px; margin:6px 0; }
.bubble li { margin: 4px 0; }
.bubble h1,.bubble h2,.bubble h3 { font-family:'Syne',sans-serif; color:#a78bfa; margin:10px 0 5px; }
.bubble h1{font-size:1.1em} .bubble h2{font-size:1em} .bubble h3{font-size:0.95em}
.bubble blockquote { border-left:3px solid var(--accent); padding-left:12px; color:var(--muted); margin:8px 0; }

.typing { display:flex; align-items:center; gap:5px; padding:14px 16px; }
.typing span {
  width:6px; height:6px; border-radius:50%;
  background:var(--accent2); animation:bounce 1.2s ease-in-out infinite;
}
.typing span:nth-child(2){animation-delay:.2s} .typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.4}40%{transform:translateY(-6px);opacity:1}}

.err-bubble {
  background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3);
  color:#fca5a5; border-radius:12px; padding:10px 16px; font-size:0.78rem;
  align-self:center; animation:slideIn .3s ease; max-width:480px; text-align:center;
}

/* Welcome */
.welcome {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:18px; text-align:center; padding:40px;
  animation:fadeIn 0.45s ease both;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.wi {
  width:64px; height:64px; border-radius:18px;
  background:linear-gradient(135deg,rgba(124,58,237,.2),rgba(6,182,212,.2));
  border:1px solid rgba(124,58,237,.3);
  display:flex; align-items:center; justify-content:center; font-size:1.8rem;
}
.welcome h1 {
  font-family:'Syne',sans-serif; font-size:1.8rem; font-weight:800;
  background:linear-gradient(135deg,#a78bfa,#06b6d4);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.welcome p { color:var(--muted); font-size:0.8rem; max-width:310px; line-height:1.65; }
.suggs { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:6px; }
.sug {
  padding:8px 14px; border-radius:100px;
  border:1px solid var(--border); background:var(--surface);
  color:var(--muted); font-size:0.73rem;
  font-family:'JetBrains Mono',monospace;
  cursor:pointer; transition:all 0.2s;
}
.sug:hover { border-color:var(--accent); color:#a78bfa; background:rgba(124,58,237,.08); transform:translateY(-2px); }

/* ‚ïê‚ïê FOOTER ‚ïê‚ïê */
footer {
  position: relative; z-index: 10;
  padding: 12px 20px 18px;
  border-top: 1px solid var(--border);
  background: rgba(10,10,15,0.92);
  backdrop-filter: blur(20px);
  flex-shrink: 0;
}
.inp-wrap {
  display: flex; align-items: flex-end; gap: 8px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 9px 12px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.inp-wrap:focus-within { border-color: rgba(124,58,237,.5); box-shadow: 0 0 0 3px rgba(124,58,237,.07); }

#inp {
  flex:1; background:none; border:none; outline:none;
  color:var(--text); font-family:'JetBrains Mono',monospace;
  font-size:0.875rem; resize:none;
  max-height:140px; line-height:1.6; min-height:22px;
}
#inp::placeholder { color:var(--muted); }

#sndBtn {
  width:34px; height:34px; border-radius:9px; border:none;
  background:linear-gradient(135deg,#7c3aed,#06b6d4);
  color:#fff; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all 0.2s;
}
#sndBtn:hover{transform:scale(1.05);filter:brightness(1.1)}
#sndBtn:active{transform:scale(0.95)}
#sndBtn:disabled{opacity:.4;cursor:not-allowed;transform:none}

.fn { text-align:center; font-size:0.6rem; color:var(--muted); margin-top:8px; opacity:.5; }
</style>
</head>
<body>

<!-- Chat list overlay -->
<div id="chatOverlay">
  <div class="chat-panel">
    <div class="cp-head">
      <div class="cp-title">üìã –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</div>
      <button class="cp-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="cp-new">
      <button class="new-chat-btn" onclick="newChat()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
      </button>
    </div>
    <div class="cp-list" id="chatListEl"></div>
  </div>
</div>

<!-- Header -->
<header>
  <button id="menuBtn" onclick="openOverlay()">
    <span></span><span></span><span></span>
  </button>
  <div class="logo">
    <svg viewBox="0 0 36 36" fill="none">
      <circle cx="18" cy="18" r="15" stroke="#7c3aed" stroke-width="1" stroke-dasharray="4 2" class="logo-ring"/>
      <circle cx="18" cy="18" r="8" fill="url(#g1)"/>
      <circle cx="18" cy="18" r="3" fill="#fff" opacity="0.9"/>
      <defs>
        <linearGradient id="g1" x1="10" y1="10" x2="26" y2="26">
          <stop offset="0%" stop-color="#7c3aed"/>
          <stop offset="100%" stop-color="#06b6d4"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
  <div class="h-info">
    <div class="h-title" id="hTitle">NOVA AI</div>
    <div class="h-sub">powered by groq</div>
  </div>
  <div class="h-right">
    <div class="model-badge" onclick="toggleModels()" id="mBadge">llama-3.3-70b ‚ñæ</div>
    <div class="sdot" id="sdot"></div>
  </div>
</header>

<!-- Model selector -->
<div class="msel" id="msel">
  <div class="msel-scroll">
    <div class="msel-group">‚ö° PRODUCTION</div>
    <div class="mo active" onclick="selModel('llama-3.3-70b-versatile','llama-3.3-70b')">
      <span class="mn">llama-3.3-70b-versatile</span>
      <span class="md2">Meta ¬∑ 70B ¬∑ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</span>
    </div>
    <div class="mo" onclick="selModel('llama-3.1-8b-instant','llama-3.1-8b-instant')">
      <span class="mn">llama-3.1-8b-instant</span>
      <span class="md2">Meta ¬∑ 8B ¬∑ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π</span>
    </div>
    <div class="mo" onclick="selModel('openai/gpt-oss-120b','gpt-oss-120b')">
      <span class="mn">openai/gpt-oss-120b</span>
      <span class="md2">OpenAI OSS ¬∑ 120B ¬∑ –º–æ—â–Ω—ã–π</span>
    </div>
    <div class="mo" onclick="selModel('openai/gpt-oss-20b','gpt-oss-20b')">
      <span class="mn">openai/gpt-oss-20b</span>
      <span class="md2">OpenAI OSS ¬∑ 20B ¬∑ –±—ã—Å—Ç—Ä—ã–π</span>
    </div>
    <div class="msel-group">üî¨ PREVIEW</div>
    <div class="mo" onclick="selModel('meta-llama/llama-4-maverick-17b-128e-instruct','llama-4-maverick')">
      <span class="mn">llama-4-maverick-17b</span>
      <span class="md2">Meta Llama 4 ¬∑ 128 —ç–∫—Å–ø–µ—Ä—Ç–æ–≤</span>
    </div>
    <div class="mo" onclick="selModel('meta-llama/llama-4-scout-17b-16e-instruct','llama-4-scout')">
      <span class="mn">llama-4-scout-17b</span>
      <span class="md2">Meta Llama 4 Scout ¬∑ –ª—ë–≥–∫–∏–π</span>
    </div>
    <div class="mo" onclick="selModel('moonshotai/kimi-k2-instruct-0905','kimi-k2')">
      <span class="mn">kimi-k2-instruct</span>
      <span class="md2">Moonshot AI ¬∑ Kimi K2</span>
    </div>
    <div class="msel-group">üß† REASONING</div>
    <div class="mo" onclick="selModel('qwen/qwen3-32b','qwen3-32b')">
      <span class="mn">qwen3-32b</span>
      <span class="md2">Qwen 3 ¬∑ 32B ¬∑ reasoning</span>
    </div>
    <div class="mo" onclick="selModel('deepseek-r1-distill-llama-70b','deepseek-r1-70b')">
      <span class="mn">deepseek-r1-distill-llama-70b</span>
      <span class="md2">DeepSeek R1 ¬∑ —Ü–µ–ø–æ—á–∫–∞ –º—ã—Å–ª–µ–π</span>
    </div>
    <div class="mo" onclick="selModel('deepseek-r1-distill-qwen-32b','deepseek-r1-32b')">
      <span class="mn">deepseek-r1-distill-qwen-32b</span>
      <span class="md2">DeepSeek R1 Qwen ¬∑ 32B</span>
    </div>
    <div class="msel-group">üì¶ –î–†–£–ì–ò–ï</div>
    <div class="mo" onclick="selModel('mixtral-8x7b-32768','mixtral-8x7b')">
      <span class="mn">mixtral-8x7b-32768</span>
      <span class="md2">Mistral ¬∑ 32k –∫–æ–Ω—Ç–µ–∫—Å—Ç</span>
    </div>
    <div class="mo" onclick="selModel('gemma2-9b-it','gemma2-9b')">
      <span class="mn">gemma2-9b-it</span>
      <span class="md2">Google Gemma 2 ¬∑ 9B</span>
    </div>
  </div>
</div>

<!-- Chat -->
<div id="chat"></div>

<!-- Footer -->
<footer>
  <div class="inp-wrap">
    <textarea id="inp" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button id="sndBtn" onclick="sendMsg()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
  <div class="fn" id="fn">NOVA ¬∑ Groq ¬∑ llama-3.3-70b-versatile</div>
</footer>

<script>
const GROQ_KEY = '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';
const GROQ_URL = 'https://api.groq.com/openai/v1/chat/completions';
const SYS = `–¢—ã ‚Äî NOVA, —É–º–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏. –ë—É–¥—å —É–º–Ω—ã–º, –ø–æ–ª–µ–∑–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –Ω–µ–º–Ω–æ–≥–æ —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π markdown –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∫–æ–¥. –û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ.`;

let model = 'llama-3.3-70b-versatile';
let loading = false;
let activeCid = null;

const chatEl = document.getElementById('chat');
const inpEl = document.getElementById('inp');
const sndBtn = document.getElementById('sndBtn');
const sdot = document.getElementById('sdot');
const titleEl = document.getElementById('hTitle');
const overlay = document.getElementById('chatOverlay');
const listEl = document.getElementById('chatListEl');

// ‚îÄ‚îÄ localStorage ‚îÄ‚îÄ
function allChats() {
  try { return JSON.parse(localStorage.getItem('nova_chats')||'[]'); } catch { return []; }
}
function saveChats(cs) { localStorage.setItem('nova_chats', JSON.stringify(cs)); }
function getChat(id) { return allChats().find(c=>c.id===id)||null; }
function patchChat(id, p) {
  const cs=allChats(), i=cs.findIndex(c=>c.id===id);
  if (i!==-1) { cs[i]={...cs[i],...p}; saveChats(cs); }
}
function delChat(id) { saveChats(allChats().filter(c=>c.id!==id)); }
function mkChat(title='–ù–æ–≤—ã–π —á–∞—Ç') {
  const id='c'+Date.now();
  const c={id, title, messages:[], ts:Date.now()};
  const cs=allChats(); cs.unshift(c); saveChats(cs); return c;
}

// ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ
function openOverlay() { renderList(); overlay.classList.add('open'); }
function closeOverlay() { overlay.classList.remove('open'); }
overlay.addEventListener('click', e => { if (e.target===overlay) closeOverlay(); });

// ‚îÄ‚îÄ Render list ‚îÄ‚îÄ
function renderList() {
  const cs = allChats();
  if (!cs.length) {
    listEl.innerHTML = `<div class="cp-empty"><span>üóÇÔ∏è</span>–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.<br>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>`;
    return;
  }
  listEl.innerHTML = '';
  cs.forEach(c => {
    const el = document.createElement('div');
    el.className = 'ci' + (c.id===activeCid?' active':'');
    const ds = new Date(c.ts).toLocaleDateString('ru-RU',{day:'numeric',month:'short'});
    el.innerHTML = `
      <div class="ci-icon">${c.id===activeCid?'‚ñ∂':'üí¨'}</div>
      <div class="ci-body" id="body_${c.id}">
        <div class="ci-name">${esc(c.title)}</div>
        <div class="ci-meta">${ds} ¬∑ ${c.messages.length} —Å–æ–æ–±—â.</div>
      </div>
      <div class="ci-actions">
        <button class="ci-btn edit" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" onclick="startEdit(event,'${c.id}')">‚úèÔ∏è</button>
        <button class="ci-btn del" title="–£–¥–∞–ª–∏—Ç—å" onclick="rmChat(event,'${c.id}')">üóëÔ∏è</button>
      </div>`;
    el.addEventListener('click', e => {
      if (e.target.closest('.ci-actions')) return;
      if (document.getElementById('edit_'+c.id)) return;
      loadChat(c.id); closeOverlay();
    });
    listEl.appendChild(el);
  });
}

// ‚îÄ‚îÄ Edit title ‚îÄ‚îÄ
function startEdit(e, id) {
  e.stopPropagation();
  const c = getChat(id); if (!c) return;
  const bodyEl = document.getElementById('body_'+id);
  const ciEl = bodyEl.closest('.ci');
  bodyEl.innerHTML = `<input class="ci-inp" id="edit_${id}" value="${esc(c.title)}" onclick="event.stopPropagation()" onkeydown="editKey(event,'${id}')">`;
  const inp = document.getElementById('edit_'+id);
  inp.focus(); inp.select();
  ciEl.querySelector('.ci-actions').innerHTML = `
    <button class="ci-btn save" onclick="saveEdit(event,'${id}')">‚úì</button>
    <button class="ci-btn cancel" onclick="renderList()">‚úï</button>`;
}
function editKey(e, id) {
  if (e.key==='Enter') saveEdit(e, id);
  if (e.key==='Escape') renderList();
  e.stopPropagation();
}
function saveEdit(e, id) {
  e.stopPropagation();
  const inp = document.getElementById('edit_'+id); if (!inp) return;
  const val = inp.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  patchChat(id, {title:val});
  if (id===activeCid) titleEl.textContent = val;
  renderList();
}

// ‚îÄ‚îÄ Delete ‚îÄ‚îÄ
function rmChat(e, id) {
  e.stopPropagation();
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
  delChat(id);
  if (activeCid===id) {
    const cs = allChats();
    if (cs.length) loadChat(cs[0].id);
    else { activeCid=null; showWelcome(); titleEl.textContent='NOVA AI'; }
  }
  renderList();
}

// ‚îÄ‚îÄ Chat ops ‚îÄ‚îÄ
function newChat() {
  const c = mkChat(); activeCid = c.id;
  showWelcome(); titleEl.textContent='NOVA AI';
  renderList(); closeOverlay(); inpEl.focus();
}

function loadChat(id) {
  activeCid = id;
  const c = getChat(id); if (!c) return;
  titleEl.textContent = c.title==='–ù–æ–≤—ã–π —á–∞—Ç' ? 'NOVA AI' : c.title;
  chatEl.innerHTML = '';
  if (!c.messages.length) showWelcome();
  else c.messages.forEach(m => addBubble(m.role==='user'?'user':'ai', m.content, false));
}

// ‚îÄ‚îÄ Render messages ‚îÄ‚îÄ
function showWelcome() {
  chatEl.innerHTML = `
    <div class="welcome">
      <div class="wi">‚ö°</div>
      <h1>NOVA AI</h1>
      <p>–ù–∞—Å—Ç–æ—è—â–∏–π –ò–ò –Ω–∞ –±–∞–∑–µ Groq ‚Äî –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.</p>
      <div class="suggs">
        <button class="sug" onclick="qs('–û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—É—é –∑–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏')">–ö–≤–∞–Ω—Ç–æ–≤–∞—è –∑–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç—å</button>
        <button class="sug" onclick="qs('–ù–∞–ø–∏—à–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ Python')">–ö–æ–¥ –Ω–∞ Python</button>
        <button class="sug" onclick="qs('–ü—Ä–∏–¥—É–º–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –±–∏–∑–Ω–µ—Å-–∏–¥–µ—é')">–ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è</button>
        <button class="sug" onclick="qs('–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å?')">–ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏</button>
        <button class="sug" onclick="qs('–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑ –ø—Ä–æ –ò–ò')">–†–∞—Å—Å–∫–∞–∑ –ø—Ä–æ –ò–ò</button>
        <button class="sug" onclick="qs('–ß—Ç–æ —Ç–∞–∫–æ–µ –±–ª–æ–∫—á–µ–π–Ω?')">–ë–ª–æ–∫—á–µ–π–Ω</button>
      </div>
    </div>`;
}

function addBubble(role, text, anim=true) {
  chatEl.querySelector('.welcome')?.remove();
  const el = document.createElement('div');
  el.className = `msg ${role}`;
  if (!anim) el.style.animation = 'none';
  const av = document.createElement('div');
  av.className = 'av';
  av.textContent = role==='user' ? '–í–´' : 'AI';
  const bub = document.createElement('div');
  bub.className = 'bubble';
  bub.innerHTML = role==='ai' ? mdParse(text) : esc(text);
  el.appendChild(av); el.appendChild(bub);
  chatEl.appendChild(el);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showTyping() {
  const el=document.createElement('div'); el.className='msg ai'; el.id='typ';
  const av=document.createElement('div'); av.className='av'; av.textContent='AI';
  const b=document.createElement('div'); b.className='bubble';
  b.innerHTML='<div class="typing"><span></span><span></span><span></span></div>';
  el.appendChild(av); el.appendChild(b);
  chatEl.appendChild(el); chatEl.scrollTop=chatEl.scrollHeight;
}
function hideTyping() { document.getElementById('typ')?.remove(); }

function showErr(msg) {
  const el=document.createElement('div'); el.className='err-bubble'; el.textContent=msg;
  chatEl.appendChild(el); chatEl.scrollTop=chatEl.scrollHeight;
  setTimeout(()=>el.remove(), 6000);
}

// ‚îÄ‚îÄ Send ‚îÄ‚îÄ
async function sendMsg() {
  const text = inpEl.value.trim();
  if (!text || loading) return;

  if (!activeCid) { const c=mkChat(); activeCid=c.id; }

  loading=true; sndBtn.disabled=true; setSt('loading');

  addBubble('user', text);
  inpEl.value=''; autoResize(inpEl);
  showTyping();

  // –ß–∏—Ç–∞–µ–º —Å–≤–µ–∂–∏–π —á–∞—Ç –∏–∑ localStorage (—Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ —á–∞—Ç–∞!)
  const c = getChat(activeCid);
  c.messages.push({ role:'user', content: text });

  if (c.messages.length===1) {
    c.title = text.length>42 ? text.slice(0,42)+'‚Ä¶' : text;
    titleEl.textContent = c.title;
  }
  patchChat(activeCid, { messages: c.messages, title: c.title });

  // –°—Ç—Ä–æ–∏–º –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
  const apiMessages = [
    { role:'system', content: SYS },
    ...c.messages.map(m => ({ role: m.role, content: String(m.content || '') }))
  ];

  try {
    const res = await fetch(GROQ_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${GROQ_KEY}` },
      body: JSON.stringify({ model, messages: apiMessages, temperature: 0.8, max_tokens: 2048 })
    });

    if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.error?.message||`–û—à–∏–±–∫–∞ ${res.status}`); }

    const data = await res.json();
    let reply = data.choices?.[0]?.message?.content || '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç';

    // –£–±–∏—Ä–∞–µ–º <think>...</think> –±–ª–æ–∫–∏ (DeepSeek R1, Qwen3 –∏ –¥—Ä.)
    reply = reply.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
    if (!reply) reply = '(–º–æ–¥–µ–ª—å –Ω–µ –¥–∞–ª–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)';

    hideTyping();
    addBubble('ai', reply);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    c.messages.push({ role:'assistant', content: reply });
    patchChat(activeCid, { messages: c.messages });
    setSt('');

  } catch(e) {
    hideTyping(); showErr('‚ö†Ô∏è '+e.message);
    c.messages.pop();
    patchChat(activeCid, { messages: c.messages });
    setSt('error'); setTimeout(()=>setSt(''), 3000);
  }

  loading=false; sndBtn.disabled=false; inpEl.focus();
}

function qs(t) { inpEl.value=t; sendMsg(); }

// ‚îÄ‚îÄ Models ‚îÄ‚îÄ
function toggleModels() { document.getElementById('msel').classList.toggle('open'); }
function selModel(id, label) {
  model=id;
  document.getElementById('mBadge').textContent=label+' ‚ñæ';
  document.querySelectorAll('.mo').forEach(o=>o.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById('msel').classList.remove('open');
  document.getElementById('fn').textContent=`NOVA ¬∑ Groq ¬∑ ${id}`;
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function setSt(s) { sdot.className='sdot'+(s?' '+s:''); }

let copyIdx = 0;
function mdParse(t) {
  return t
    .replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      const id = 'cp' + (++copyIdx);
      const rawCode = code.trim();
      // –ö–æ–¥–∏—Ä—É–µ–º –≤ base64 —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
      const encoded = btoa(unescape(encodeURIComponent(rawCode)));
      return `<div class="pre-wrap"><button class="copy-btn" data-code="${encoded}" onclick="copyCode(this)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><pre><code id="${id}">${esc(rawCode)}</code></pre></div>`;
    })
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>')
    .replace(/^\- (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g,m=>`<ul>${m}</ul>`)
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>');
}

function copyCode(btn) {
  // –ß–∏—Ç–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ (–Ω–µ –∏–∑ DOM ‚Äî —Ç–∞–º –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω)
  const encoded = btn.getAttribute('data-code');
  let text;
  try {
    text = decodeURIComponent(escape(atob(encoded)));
  } catch(e) {
    text = encoded; // fallback
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => flashCopied(btn)).catch(() => fallbackCopy(text, btn));
  } else {
    fallbackCopy(text, btn);
  }
}

function fallbackCopy(text, btn) {
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    flashCopied(btn);
  } catch(e) {
    btn.textContent = '–æ—à–∏–±–∫–∞';
    setTimeout(() => { btn.textContent = '–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 1500);
  }
}

function flashCopied(btn) {
  btn.textContent = '‚úì —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
  btn.classList.add('copied');
  setTimeout(() => { btn.textContent = '–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; btn.classList.remove('copied'); }, 2000);
}

function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,140)+'px'; }

document.addEventListener('click', e => {
  if (!e.target.closest('.model-badge') && !e.target.closest('.msel'))
    document.getElementById('msel').classList.remove('open');
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(function() {
  const cs = allChats();
  if (cs.length) { activeCid=cs[0].id; loadChat(activeCid); }
  else showWelcome();
  inpEl.focus();
})();
</script>
</body>
</html>
